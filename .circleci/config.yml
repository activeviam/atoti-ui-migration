version: 2.1

orbs:
  node: circleci/node@5.0.2

commands:
  login:
    description: "Log in to Artifactory, allowing to install private @activeviam dependencies."
    steps:
      - run:
          name: Log into artifactory & Link @activeviam packages to the internal registry
          command: |
            npm config set //activeviam.jfrog.io/artifactory/api/npm/npm-internal/:_authToken $ARTIFACTORY_NPM_TOKEN
            npm config set @activeviam:registry https://activeviam.jfrog.io/artifactory/api/npm/npm-internal/

jobs:
  build-and-test:
    executor:
      name: node/default
      tag: "18.12.1"
    resource_class: xlarge
    steps:
      - checkout
      - login
      - run: yarn install --frozen-lockfile
      - run: yarn build
      - run: yarn lint
      - run: yarn ci:test

workflows:
  # Used to protect the main branch: it should block merging into main when failing.
  # See https://github.com/activeviam/activeui-migration/settings/branch_protection_rules/15886613
  check-pull-request:
    jobs:
      - build-and-test:
          filters:
            branches:
              ignore:
                - main
